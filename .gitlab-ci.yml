# GitLab CI/CD Pipeline for Impulse BBS Automated Builds

stages:
  - build
  - release

variables:
  DOCKER_DRIVER: overlay2
  APT_CACHE_DIR: "$CI_PROJECT_DIR/apt-cache"
  DEBIAN_FRONTEND: noninteractive

build_impulse:
  stage: build
  image: ubuntu:20.04
  only:
    - main
  before_script:
    - echo "Building Impulse BBS - Pipeline $CI_PIPELINE_ID"
    - echo "Commit $CI_COMMIT_SHORT_SHA by $CI_COMMIT_AUTHOR"
    ## Setup APT caching
    - mkdir -p "$APT_CACHE_DIR"
    - echo "Dir::Cache::Archives \"$APT_CACHE_DIR\";" > /etc/apt/apt.conf.d/99cache
    - echo "Dir::Cache::pkgcache \"$APT_CACHE_DIR/pkgcache.bin\";" >> /etc/apt/apt.conf.d/99cache
    - echo "Dir::Cache::srcpkgcache \"$APT_CACHE_DIR/srcpkgcache.bin\";" >> /etc/apt/apt.conf.d/99cache
    ## End caching stuff
    # Update and install
    - apt-get update
    - DEBIAN_FRONTEND=noninteractive apt-get install -y dosbox xvfb curl
    - mkdir -p /tmp/impulse_dosbox
    - mkdir -p build
    
  script:
    - cp -r BP /tmp/impulse_dosbox/bp
    - |
      cat > dosbox.conf << EOF
      [sdl]
      windowresolution=800x600
      output=surface
      autolock=false
      
      [dosbox]
      machine=svga_s3
      memsize=16
      
      [cpu]
      core=auto
      cputype=auto
      cycles=10000
      
      [mixer]
      nosound=true
      
      [midi]
      mpu401=none
      
      [sblaster]
      sbtype=none
      
      [gus]
      gus=false
      
      [speaker]
      pcspeaker=false
      
      [autoexec]
      mount c: /tmp/impulse_dosbox
      mount d: $PWD/source
      mount e: $PWD/output
      mount f: $PWD/include
      d:
      set PATH=c:\\bp\\bin;%PATH%
      call c:\\build.bat
      exit
      EOF
    - |
      cat > /tmp/impulse_dosbox/build.bat << 'EOF'
      @echo off
      echo === Impulse BBS Compilation ===
      echo [LOG] Checking Borland Pascal installation...
      
      if exist c:\bp\bin\bpc.exe goto bpfound
      echo [ERROR] Borland Pascal not found
      goto end
      
      :bpfound
      echo [SUCCESS] Found Borland Pascal compiler
      echo [LOG] Switching to source directory...
      d:
      echo [LOG] Current directory contents:
      dir *.pas
      
      if exist imp.pas goto impfound
      echo [ERROR] imp.pas not found
      goto end
      
      :impfound
      echo [SUCCESS] Found imp.pas in source directory
      echo [LOG] Setting PATH and starting compilation...
      
      echo [LOG] === STEP 1: BUILD PHASE ===
      echo [CMD] bpc -$G+ -B -Uf:\ -Ee:\ imp.pas
      bpc -$G+ -B -Uf:\ -Ee:\ imp.pas
      if errorlevel 1 goto buildfail
      echo [SUCCESS] Build phase completed
      goto step2
      
      :buildfail
      echo [ERROR] Build phase failed
      goto end
      
      :step2
      echo [LOG] === STEP 2: FINAL COMPILATION ===
      echo [CMD] bpc -Uf:\ -Ee:\ imp.pas
      bpc -Uf:\ -Ee:\ imp.pas
      if errorlevel 1 goto compfail
      echo [SUCCESS] Final compilation completed
      goto checkfiles
      
      :compfail
      echo [ERROR] Final compilation failed
      goto end
      
      :checkfiles
      echo [LOG] === VERIFYING OUTPUT FILES ===
      e:
      if exist IMP.EXE echo [SUCCESS] IMP.EXE created
      if exist IMP.OVR echo [SUCCESS] IMP.OVR created
      dir *.exe *.ovr
      
      :end
      echo [LOG] === BUILD PROCESS COMPLETE ===
      EOF
    - echo "Starting DOSBox compilation with enhanced logging..."
    - xvfb-run -a dosbox -conf dosbox.conf -noconsole
    - |
      if [ -f "output/IMP.EXE" ] && [ -f "output/IMP.OVR" ]; then
        echo "Compilation successful!"
        
        BUILD_DIR="build/build-$CI_PIPELINE_ID"
        mkdir -p "$BUILD_DIR"
        
        cp output/IMP.EXE "$BUILD_DIR/"
        cp output/IMP.OVR "$BUILD_DIR/"
        
        cat > "$BUILD_DIR/build-info.txt" << EOF
      Impulse BBS 7.1 Build Information
      ================================
      Build Date: $(date)
      Pipeline ID: $CI_PIPELINE_ID
      Job ID: $CI_JOB_ID
      Commit SHA: $CI_COMMIT_SHA
      Commit Message: $CI_COMMIT_MESSAGE
      Commit Author: $CI_COMMIT_AUTHOR
      
      Files:
      EOF
        ls -la "$BUILD_DIR"/*.EXE "$BUILD_DIR"/*.OVR >> "$BUILD_DIR/build-info.txt"
        
        echo "Build complete!"
        ls -la "$BUILD_DIR/"
        
        echo ""
        echo "BUILD ARTIFACTS READY:"
        echo "Browse: $CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/browse/build/build-$CI_PIPELINE_ID/"
        echo "Download: $CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/download"
        echo "IMP.EXE: $CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/build/build-$CI_PIPELINE_ID/IMP.EXE"
        echo "IMP.OVR: $CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/build/build-$CI_PIPELINE_ID/IMP.OVR"
        
        # Add public API URLs for easier access
        echo ""
        echo "PUBLIC API DOWNLOAD LINKS:"
        echo "Full Archive: $CI_PROJECT_URL/api/v4/projects/$CI_PROJECT_ID/jobs/artifacts/main/download?job=build_impulse"
        echo "Browse Files: $CI_PROJECT_URL/-/jobs/artifacts/main/browse?job=build_impulse" 
        echo "Direct IMP.EXE: $CI_PROJECT_URL/api/v4/projects/$CI_PROJECT_ID/jobs/artifacts/main/raw/build/build-$CI_PIPELINE_ID/IMP.EXE?job=build_impulse"
        echo "Direct IMP.OVR: $CI_PROJECT_URL/api/v4/projects/$CI_PROJECT_ID/jobs/artifacts/main/raw/build/build-$CI_PIPELINE_ID/IMP.OVR?job=build_impulse"
        
        if [ -f "latest-build.html" ]; then
          sed -i "s/PIPELINE_ID_PLACEHOLDER/$CI_PIPELINE_ID/g" latest-build.html
          sed -i "s/JOB_ID_PLACEHOLDER/$CI_JOB_ID/g" latest-build.html
          sed -i "s/BUILD_DATE_PLACEHOLDER/$(date)/g" latest-build.html
          sed -i "s/COMMIT_SHA_PLACEHOLDER/$CI_COMMIT_SHORT_SHA/g" latest-build.html
          cp latest-build.html build/
          echo "Latest build page: $CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/build/latest-build.html"
        fi
        
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"ðŸŽ‰ Impulse BBS Build #'$CI_PIPELINE_ID' Complete!\nðŸ“¦ Release: '$CI_PROJECT_URL'/-/releases/build-'$CI_PIPELINE_ID'\nðŸ“ Browse: '$CI_PROJECT_URL'/-/jobs/'$CI_JOB_ID'/artifacts/browse/build/build-'$CI_PIPELINE_ID'/\nâ¬‡ï¸ Download: '$CI_PROJECT_URL'/-/jobs/'$CI_JOB_ID'/artifacts/download\nðŸŒ Public API: '$CI_PROJECT_URL'/api/v4/projects/'$CI_PROJECT_ID'/jobs/artifacts/main/download?job=build_impulse"}' \
          "$SLACK_WEBHOOK_URL"
        fi
        
      else
        echo "Compilation failed"
        ls -la output/ || echo "No output directory"
        exit 1
      fi
    
  artifacts:
    access: all  # ðŸ”‘ KEY CHANGE: Makes artifacts publicly downloadable (replaces deprecated 'public: true')
    name: "impulse-bbs-build-$CI_PIPELINE_ID"
    paths:
      - build/build-$CI_PIPELINE_ID/
      - build/latest-build.html
    expire_in: 1 year
    when: always

# Optional: Publish artifacts to GitLab Pages (always public)
pages:
  stage: release
  dependencies:
    - build_impulse
  script:
    - mkdir public
    - cp -r build/build-$CI_PIPELINE_ID/* public/
    - echo "Artifacts published to GitLab Pages"
    - echo "Direct download links:"
    - echo "IMP.EXE: $CI_PAGES_URL/IMP.EXE"
    - echo "IMP.OVR: $CI_PAGES_URL/IMP.OVR"
  artifacts:
    paths:
      - public
  only:
    - main

# Create GitLab Release with build artifacts
create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  dependencies:
    - build_impulse
  only:
    - main
  script:
    - echo "Creating release for build $CI_PIPELINE_ID" && BUILD_DIR="build/build-$CI_PIPELINE_ID"
    - test -f "$BUILD_DIR/IMP.EXE" && test -f "$BUILD_DIR/IMP.OVR" && echo "Build artifacts verified"
    - |
      cat > release_desc.txt << EOF
      Impulse BBS 7.1 - Build $CI_PIPELINE_ID
      
      Automated build from commit $CI_COMMIT_SHORT_SHA
      
      Build Information:
      - Date: $CI_JOB_STARTED_AT
      - Pipeline: $CI_PIPELINE_ID  
      - Commit: $CI_COMMIT_MESSAGE
      - Author: $CI_COMMIT_AUTHOR
      
      ## ðŸŒ Public Download Links (No Login Required):
      
      **API Downloads (Direct Links):**
      - ðŸ“¦ [Full Build Archive](${CI_PROJECT_URL}/api/v4/projects/${CI_PROJECT_ID}/jobs/artifacts/main/download?job=build_impulse)
      - ðŸ–¥ï¸ [IMP.EXE Only](${CI_PROJECT_URL}/api/v4/projects/${CI_PROJECT_ID}/jobs/artifacts/main/raw/build/build-${CI_PIPELINE_ID}/IMP.EXE?job=build_impulse) 
      - ðŸ“„ [IMP.OVR Only](${CI_PROJECT_URL}/api/v4/projects/${CI_PROJECT_ID}/jobs/artifacts/main/raw/build/build-${CI_PIPELINE_ID}/IMP.OVR?job=build_impulse)
      - ðŸ“ [Browse All Files](${CI_PROJECT_URL}/-/jobs/artifacts/main/browse?job=build_impulse)
      
      **Legacy UI Links:**
      - Browse All: $CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/browse/build/build-$CI_PIPELINE_ID/
      - Download ZIP: $CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/download
      
      **Installation:** Download both IMP.EXE and IMP.OVR files, place in same directory, run IMP.EXE
      EOF
    - RELEASE_DESC=$(cat release_desc.txt)
    - |
      release-cli create \
        --name "Impulse BBS Build $CI_PIPELINE_ID" \
        --tag-name "build-$CI_PIPELINE_ID" \
        --description "$RELEASE_DESC" \
        --assets-link "{\"name\":\"Download Full Build (Public API)\",\"url\":\"${CI_PROJECT_URL}/api/v4/projects/${CI_PROJECT_ID}/jobs/artifacts/main/download?job=build_impulse\",\"link_type\":\"package\"}" \
        --assets-link "{\"name\":\"IMP.EXE (Direct Download)\",\"url\":\"${CI_PROJECT_URL}/api/v4/projects/${CI_PROJECT_ID}/jobs/artifacts/main/raw/build/build-${CI_PIPELINE_ID}/IMP.EXE?job=build_impulse\",\"link_type\":\"other\"}" \
        --assets-link "{\"name\":\"IMP.OVR (Direct Download)\",\"url\":\"${CI_PROJECT_URL}/api/v4/projects/${CI_PROJECT_ID}/jobs/artifacts/main/raw/build/build-${CI_PIPELINE_ID}/IMP.OVR?job=build_impulse\",\"link_type\":\"other\"}"

